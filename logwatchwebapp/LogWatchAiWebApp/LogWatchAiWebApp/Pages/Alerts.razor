@page "/alerts"
@inject ApiClient Api
@inject NavigationManager Nav

<h2 class="mb-4">Alerts</h2>

@if (IsLoading)
{
    <div class="text-center my-5">
        <div class="spinner-border text-danger"></div>
    </div>
}
else if (Alertings == null || Alertings.Count == 0)
{
    <div class="alert alert-warning">No alerts found.</div>
}
else
{
    <table class="table table-hover table-striped">
        <thead class="table-dark">
        <tr>
            <th>Created</th>
            <th>Severity</th>
            <th>Message</th>
            <th>Active</th>
            <th>Source</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var a in Alertings)
        {
            <tr @onclick="() => OpenAlert(a.Id)" style="cursor:pointer">
                <td>@a.CreatedAt</td>
                <td>
                    <span class="badge @(GetSeverityClass(a.Severity))">@a.Severity</span>
                </td>
                <td>@(a.Message?.Length > 60 ? a.Message.Substring(0, 60) + "…" : a.Message)</td>
                <td>@((a.Active ?? false) ? "✔️" : "❌")</td>
                <td>@a.SourceId</td>
            </tr>
        }
        </tbody>
    </table>
}

@code {

    /// <summary>
    /// Stores the list of retrieved alerts.
    /// </summary>
    List<AlertDto> Alertings = new();

    /// <summary>
    /// Indicates whether the component is currently loading data from the API.
    /// </summary>
    bool IsLoading = true;

    /// <summary>
    /// Loads all alerts on component initialization.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;
        Alertings = await Api.GetAlertsAsync();
        IsLoading = false;
    }

    /// <summary>
    /// Navigates to the alert details page for the specified alert ID.
    /// </summary>
    void OpenAlert(string id)
    {
        Nav.NavigateTo($"/alert/{id}");
    }

    /// <summary>
    /// Returns the Bootstrap badge class based on severity.
    /// </summary>
    /// <param name="severity">The alert severity.</param>
    /// <returns>CSS class for severity badge.</returns>
    string GetSeverityClass(string severity) => severity switch
    {
        "CRITICAL" => "bg-danger",
        "HIGH"     => "bg-warning text-dark",
        "MEDIUM"   => "bg-info text-dark",
        "LOW"      => "bg-secondary",
        _          => "bg-light text-dark"
    };
}
